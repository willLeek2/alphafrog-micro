services:
  # postgres:  <-- 用户使用的是宿主机 PG
  #   image: postgres:16-alpine
  #   container_name: alphafrog-postgres
  #   environment:
  #     POSTGRES_DB: ${AF_DB_MAIN_DATABASE:-alphafrog}
  #     POSTGRES_USER: ${AF_DB_MAIN_USER:-alphafrog}
  #     POSTGRES_PASSWORD: ${AF_DB_MAIN_PASSWORD:-alphafrog_pass}
  #   ports:
  #     - "5432:5432"
  #   volumes:
  #     - alphafrog_pgdata:/var/lib/postgresql/data
  #     - ./portfolio_schema.sql:/docker-entrypoint-initdb.d/10_portfolio_schema.sql:ro
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
  #     interval: 5s
  #     timeout: 5s
  #     retries: 20
  #   networks:
  #     - alphafrog-network

  redis:
    image: redis:7-alpine
    container_name: alphafrog-redis
    command: ["redis-server", "--appendonly", "yes", "--requirepass", "${AF_REDIS_PASSWORD:-Excited1s}"]
    ports:
      - "6379:6379"
    volumes:
      - alphafrog_redisdata:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${AF_REDIS_PASSWORD:-Excited1s}", "ping"]
      interval: 5s
      timeout: 3s
      retries: 20
    deploy:
      resources:
        limits:
          memory: 256M
    networks:
      - alphafrog-network

  # zookeeper/kafka: 已移除，迁移至 RabbitMQ

  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    container_name: alphafrog-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: ${AF_RABBITMQ_USER:-alphafrog}
      RABBITMQ_DEFAULT_PASS: ${AF_RABBITMQ_PASS:-Excited1s}
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - alphafrog_rabbitmq:/var/lib/rabbitmq
    deploy:
      resources:
        limits:
          memory: 300M
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - alphafrog-network

  nacos:
    image: nacos/nacos-server:v2.5.0
    container_name: alphafrog-nacos
    environment:
      MODE: standalone
      PREFER_HOST_MODE: hostname
      NACOS_AUTH_ENABLE: "false"
      # Memory Optimization
      JVM_XMS: 512m
      JVM_XMX: 512m
    ports:
      - "8848:8848"
    volumes:
      - ./data/nacos/logs:/home/nacos/logs
      - ./data/nacos/data:/home/nacos/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8848/nacos/v1/console/health/readiness"]
      interval: 10s
      timeout: 10s
      retries: 20
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 1G
    networks:
      - alphafrog-network

  meilisearch:
    image: getmeili/meilisearch:v1.12
    container_name: alphafrog-meilisearch
    environment:
      MEILI_MASTER_KEY: ${AF_MEILI_API_KEY:-alphafrog_search_key}
      MEILI_HTTP_ADDR: 0.0.0.0:7700
      MEILI_MAX_INDEXING_MEMORY: 600Mb
      MEILI_MAX_INDEXING_THREADS: 1
      MEILI_EXPERIMENTAL_REDUCE_INDEXING_MEMORY_USAGE: "true"
      MEILI_EXPERIMENTAL_SEARCH_QUEUE_SIZE: 100
    ports:
      - "7700:7700"
    volumes:
      - ./data/meilisearch:/meili_data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7700/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 1G
    networks:
      - alphafrog-network

  domestic-stock-service:
    image: alphafrog-micro-domestic-stock-service:latest
    build: ./domesticStockService
    container_name: alphafrog-domestic-stock-service
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
      nacos:
        condition: service_healthy
      meilisearch:
        condition: service_healthy
    environment:
      TZ: Asia/Shanghai
      AF_DB_MAIN_HOST: ${AF_DB_MAIN_HOST:-host.docker.internal}
      AF_DB_MAIN_PORT: 5432
      AF_DB_MAIN_DATABASE: ${AF_DB_MAIN_DATABASE:-alphafrog}
      AF_DB_MAIN_USER: ${AF_DB_MAIN_USER:-alphafrog}
      AF_DB_MAIN_PASSWORD: ${AF_DB_MAIN_PASSWORD:-alphafrog_pass}
      AF_REDIS_HOST: redis
      AF_REDIS_PASSWORD: ${AF_REDIS_PASSWORD:-Excited1s}
      AF_MEILI_HOST: http://meilisearch:7700
      AF_MEILI_API_KEY: ${AF_MEILI_API_KEY:-alphafrog_search_key}
      NACOS_ADDRESS: nacos
      TUSHARE_TOKEN: ${TUSHARE_TOKEN}
      # Memory Optimization (Medium)
      JAVA_TOOL_OPTIONS: "-Xms384m -Xmx512m"
    ports:
      - "50055:50055"
    deploy:
      resources:
        limits:
          memory: 768M
    networks:
      - alphafrog-network

  domestic-index-service:
    image: alphafrog-micro-domestic-index-service:latest
    build: ./domesticIndexService
    container_name: alphafrog-domestic-index-service
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
      nacos:
        condition: service_healthy
      meilisearch:
        condition: service_healthy
    environment:
      TZ: Asia/Shanghai
      AF_DB_MAIN_HOST: ${AF_DB_MAIN_HOST:-host.docker.internal}
      AF_DB_MAIN_PORT: 5432
      AF_DB_MAIN_DATABASE: ${AF_DB_MAIN_DATABASE:-alphafrog}
      AF_DB_MAIN_USER: ${AF_DB_MAIN_USER:-alphafrog}
      AF_DB_MAIN_PASSWORD: ${AF_DB_MAIN_PASSWORD:-alphafrog_pass}
      AF_REDIS_HOST: redis
      AF_REDIS_PASSWORD: ${AF_REDIS_PASSWORD:-Excited1s}
      AF_MEILI_HOST: http://meilisearch:7700
      AF_MEILI_API_KEY: ${AF_MEILI_API_KEY:-alphafrog_search_key}
      NACOS_ADDRESS: nacos
      TUSHARE_TOKEN: ${TUSHARE_TOKEN}
      # Memory Optimization (Medium)
      JAVA_TOOL_OPTIONS: "-Xms384m -Xmx512m"
    ports:
      - "50053:50053"
    deploy:
      resources:
        limits:
          memory: 768M
    networks:
      - alphafrog-network

  domestic-fund-service:
    image: alphafrog-micro-domestic-fund-service:latest
    build: ./domesticFundService
    container_name: alphafrog-domestic-fund-service
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
      nacos:
        condition: service_healthy
      meilisearch:
        condition: service_healthy
    environment:
      TZ: Asia/Shanghai
      AF_DB_MAIN_HOST: ${AF_DB_MAIN_HOST:-host.docker.internal}
      AF_DB_MAIN_PORT: 5432
      AF_DB_MAIN_DATABASE: ${AF_DB_MAIN_DATABASE:-alphafrog}
      AF_DB_MAIN_USER: ${AF_DB_MAIN_USER:-alphafrog}
      AF_DB_MAIN_PASSWORD: ${AF_DB_MAIN_PASSWORD:-alphafrog_pass}
      AF_REDIS_HOST: redis
      AF_REDIS_PASSWORD: ${AF_REDIS_PASSWORD:-Excited1s}
      AF_MEILI_HOST: http://meilisearch:7700
      AF_MEILI_API_KEY: ${AF_MEILI_API_KEY:-alphafrog_search_key}
      NACOS_ADDRESS: nacos
      TUSHARE_TOKEN: ${TUSHARE_TOKEN}
      # Memory Optimization (Medium)
      JAVA_TOOL_OPTIONS: "-Xms384m -Xmx512m"
    ports:
      - "50052:50052"
    deploy:
      resources:
        limits:
          memory: 768M
    networks:
      - alphafrog-network

  domestic-fetch-service:
    image: alphafrog-micro-domestic-fetch-service:latest
    build: ./domesticFetchService
    container_name: alphafrog-domestic-fetch-service
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      nacos:
        condition: service_healthy
    environment:
      TZ: Asia/Shanghai
      AF_DB_MAIN_HOST: ${AF_DB_MAIN_HOST:-host.docker.internal}
      AF_DB_MAIN_PORT: 5432
      AF_DB_MAIN_DATABASE: ${AF_DB_MAIN_DATABASE:-alphafrog}
      AF_DB_MAIN_USER: ${AF_DB_MAIN_USER:-alphafrog}
      AF_DB_MAIN_PASSWORD: ${AF_DB_MAIN_PASSWORD:-alphafrog_pass}
      AF_RABBITMQ_HOST: rabbitmq
      AF_RABBITMQ_PORT: 5672
      AF_RABBITMQ_USER: ${AF_RABBITMQ_USER:-alphafrog}
      AF_RABBITMQ_PASS: ${AF_RABBITMQ_PASS:-Excited1s}
      AF_REDIS_HOST: redis
      AF_REDIS_PASSWORD: ${AF_REDIS_PASSWORD:-Excited1s}
      NACOS_ADDRESS: nacos
      NACOS_USER: ${NACOS_USER:-nacos}
      NACOS_PASSWORD: ${NACOS_PASSWORD:-nacos}
      TUSHARE_TOKEN: ${TUSHARE_TOKEN}
      LOGGING_LEVEL_APP: ${LOGGING_LEVEL_APP:-INFO}
      AF_FETCH_CONCURRENCY: ${AF_FETCH_CONCURRENCY:-3}
      # Memory Optimization (Medium - Adjusted)
      JAVA_TOOL_OPTIONS: "-Xms384m -Xmx512m"
    ports:
      - "20882:20882"
    deploy:
      resources:
        limits:
          memory: 768M
    networks:
      - alphafrog-network

  admin-service:
    image: alphafrog-micro-admin-service:latest
    build: ./adminService
    container_name: alphafrog-admin-service
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      nacos:
        condition: service_healthy
    environment:
      TZ: Asia/Shanghai
      AF_DB_MAIN_HOST: ${AF_DB_MAIN_HOST:-host.docker.internal}
      AF_DB_MAIN_PORT: 5432
      AF_DB_MAIN_DATABASE: ${AF_DB_MAIN_DATABASE:-alphafrog}
      AF_DB_MAIN_USER: ${AF_DB_MAIN_USER:-alphafrog}
      AF_DB_MAIN_PASSWORD: ${AF_DB_MAIN_PASSWORD:-alphafrog_pass}
      NACOS_ADDRESS: nacos
      ADMIN_MAGIC_PASSWORD: ${ADMIN_MAGIC_PASSWORD:-frog20191127StartFromBelieving}
      # Memory Optimization (Light)
      JAVA_TOOL_OPTIONS: "-Xms256m -Xmx256m"
    deploy:
      resources:
        limits:
          memory: 512M
    networks:
      - alphafrog-network

  portfolio-service:
    image: alphafrog-micro-portfolio-service:latest
    build: ./portfolioService
    container_name: alphafrog-portfolio-service
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      nacos:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    environment:
      TZ: Asia/Shanghai
      AF_DB_MAIN_HOST: ${AF_DB_MAIN_HOST:-host.docker.internal}
      AF_DB_MAIN_PORT: 5432
      AF_DB_MAIN_DATABASE: ${AF_DB_MAIN_DATABASE:-alphafrog}
      AF_DB_MAIN_USER: ${AF_DB_MAIN_USER:-alphafrog}
      AF_DB_MAIN_PASSWORD: ${AF_DB_MAIN_PASSWORD:-alphafrog_pass}
      AF_RABBITMQ_HOST: rabbitmq
      AF_RABBITMQ_PORT: 5672
      AF_RABBITMQ_USER: ${AF_RABBITMQ_USER:-alphafrog}
      AF_RABBITMQ_PASS: ${AF_RABBITMQ_PASS:-Excited1s}
      NACOS_ADDRESS: nacos
      NACOS_USER: ${NACOS_USER:-nacos}
      NACOS_PASSWORD: ${NACOS_PASSWORD:-nacos}
      # Memory Optimization (Medium)
      JAVA_TOOL_OPTIONS: "-Xms384m -Xmx512m"
    ports:
      - "50056:50056"
    deploy:
      resources:
        limits:
          memory: 768M
    networks:
      - alphafrog-network

  agent-service:
    image: alphafrog-micro-agent-service:latest
    build: ./agentService
    container_name: alphafrog-agent-service
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      nacos:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      TZ: Asia/Shanghai
      AF_DB_MAIN_HOST: ${AF_DB_MAIN_HOST:-host.docker.internal}
      AF_DB_MAIN_PORT: 5432
      AF_DB_MAIN_DATABASE: ${AF_DB_MAIN_DATABASE:-alphafrog}
      AF_DB_MAIN_USER: ${AF_DB_MAIN_USER:-alphafrog}
      AF_DB_MAIN_PASSWORD: ${AF_DB_MAIN_PASSWORD:-alphafrog_pass}
      AF_REDIS_HOST: redis
      AF_REDIS_PORT: 6379
      AF_REDIS_PASSWORD: ${AF_REDIS_PASSWORD:-Excited1s}
      NACOS_ADDRESS: nacos
      # Agent Service LLM 配置
      # 本地 JSON 配置文件（容器内路径）
      AF_AGENT_LLM_CONFIG_FILE: ${AF_AGENT_LLM_CONFIG_FILE:-/app/config/agent-llm.local.json}
      # 全局兜底 key（当 endpoint 未配置 apiKey 时回退）
      AF_AGENT_API_KEY: ${AF_AGENT_API_KEY:-demo}
      # 默认 endpoint 和 model（可选: openrouter, openai, fireworks）
      AF_AGENT_DEFAULT_ENDPOINT: ${AF_AGENT_DEFAULT_ENDPOINT:-openrouter}
      AF_AGENT_DEFAULT_MODEL: ${AF_AGENT_DEFAULT_MODEL:-openai/gpt-5.2}
      # 允许的模型列表（逗号分隔）
      AF_AGENT_MODELS: ${AF_AGENT_MODELS:-openai/gpt-5.2,openai/gpt-5.1,google/gemini-3-pro-preview,moonshotai/kimi-k2.5,accounts/fireworks/models/kimi-k2p5}
      # 各 endpoint 的 base-url
      AF_AGENT_ENDPOINT_OPENROUTER: ${AF_AGENT_ENDPOINT_OPENROUTER:-https://openrouter.ai/api/v1}
      AF_AGENT_ENDPOINT_OPENAI: ${AF_AGENT_ENDPOINT_OPENAI:-https://api.openai.com/v1}
      AF_AGENT_ENDPOINT_FIREWORKS: ${AF_AGENT_ENDPOINT_FIREWORKS:-https://api.fireworks.ai/inference/v1}
      # 各 endpoint 的 api-key（可选；优先级低于 JSON）
      AF_AGENT_ENDPOINT_OPENROUTER_API_KEY: ${AF_AGENT_ENDPOINT_OPENROUTER_API_KEY:-}
      AF_AGENT_ENDPOINT_OPENAI_API_KEY: ${AF_AGENT_ENDPOINT_OPENAI_API_KEY:-}
      AF_AGENT_ENDPOINT_FIREWORKS_API_KEY: ${AF_AGENT_ENDPOINT_FIREWORKS_API_KEY:-}
      # langchain4j 配置（兼容旧配置，实际使用 default endpoint）
      AF_AGENT_BASE_URL: ${AF_AGENT_BASE_URL:-https://openrouter.ai/api/v1}
      AF_AGENT_MODEL_NAME: ${AF_AGENT_MODEL_NAME:-openai/gpt-5.2}
      AF_AGENT_MAX_TOKENS: ${AF_AGENT_MAX_TOKENS:-4096}
      AF_AGENT_TEMPERATURE: ${AF_AGENT_TEMPERATURE:-0.7}
      # Reasoning 配置 (OpenRouter)
      AF_AGENT_REASONING_EFFORT: ${AF_AGENT_REASONING_EFFORT:-}
      AF_AGENT_REASONING_MAX_TOKENS: ${AF_AGENT_REASONING_MAX_TOKENS:-}
      AF_AGENT_REASONING_ENABLED: ${AF_AGENT_REASONING_ENABLED:-}
      AF_AGENT_REASONING_EXCLUDE: ${AF_AGENT_REASONING_EXCLUDE:-false}
      LOGGING_LEVEL_AGENT: ${LOGGING_LEVEL_AGENT:-INFO}
      # Memory Optimization (Heavy)
      JAVA_TOOL_OPTIONS: "-Xms512m -Xmx1g"
    volumes:
      - ./data/agent_datasets:/data/agent_datasets
      - ./agentService/config:/app/config:ro
    ports:
      - "50058:50058"
    deploy:
      resources:
        limits:
          memory: 1.5G
    networks:
      - alphafrog-network

  external-info-service:
    image: alphafrog-micro-external-info-service:latest
    build: ./externalInfoService
    container_name: alphafrog-external-info-service
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      nacos:
        condition: service_healthy
    environment:
      TZ: Asia/Shanghai
      NACOS_ADDRESS: nacos
      AF_EXTERNAL_INFO_SEARCH_LLM_CONFIG_FILE: ${AF_EXTERNAL_INFO_SEARCH_LLM_CONFIG_FILE:-/app/config/search-llm.local.json}
      LOGGING_LEVEL_EXTERNAL_INFO: ${LOGGING_LEVEL_EXTERNAL_INFO:-INFO}
      JAVA_TOOL_OPTIONS: "-Xms256m -Xmx512m"
    volumes:
      - ./externalInfoService/config:/app/config:ro
    ports:
      - "50061:50061"
    deploy:
      resources:
        limits:
          memory: 768M
    networks:
      - alphafrog-network

  python-sandbox-service:
    image: alphafrog-python-sandbox:latest
    build: ./pythonSandboxService
    container_name: alphafrog-python-sandbox-service
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      AF_SANDBOX_DATA_DIR: /data/agent_datasets
      AF_SANDBOX_DEBUG: ${AF_SANDBOX_DEBUG:-false}
    volumes:
      - ./data/agent_datasets:/data/agent_datasets
      - /var/run/docker.sock:/var/run/docker.sock
    expose:
      - "8095"
    deploy:
      resources:
        limits:
          memory: 768M
    networks:
      - alphafrog-network

  python-sandbox-gateway-service:
    image: alphafrog-micro-python-sandbox-gateway-service:latest
    build: ./pythonSandboxGatewayService
    container_name: alphafrog-python-sandbox-gateway-service
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      nacos:
        condition: service_healthy
      python-sandbox-service:
        condition: service_started
    environment:
      TZ: Asia/Shanghai
      NACOS_ADDRESS: nacos
      AF_SANDBOX_SERVICE_URL: http://python-sandbox-service:8095
      # Memory Optimization (Light)
      JAVA_TOOL_OPTIONS: "-Xms256m -Xmx256m"
    ports:
      - "50060:50060"
    deploy:
      resources:
        limits:
          memory: 512M
    networks:
      - alphafrog-network

  frontend:
    image: alphafrog-micro-frontend:latest
    build: ./frontend
    container_name: alphafrog-frontend
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      nacos:
        condition: service_healthy
      domestic-stock-service:
        condition: service_started
      domestic-index-service:
        condition: service_started
      domestic-fund-service:
        condition: service_started
      admin-service:
        condition: service_started
      portfolio-service:
        condition: service_started
      agent-service:
        condition: service_started
      external-info-service:
        condition: service_started
    environment:
      TZ: Asia/Shanghai
      AF_DB_MAIN_HOST: ${AF_DB_MAIN_HOST:-host.docker.internal}
      AF_DB_MAIN_PORT: 5432
      AF_DB_MAIN_DATABASE: ${AF_DB_MAIN_DATABASE:-alphafrog}
      AF_DB_MAIN_USER: ${AF_DB_MAIN_USER:-alphafrog}
      AF_DB_MAIN_PASSWORD: ${AF_DB_MAIN_PASSWORD:-alphafrog_pass}
      AF_RABBITMQ_HOST: rabbitmq
      AF_RABBITMQ_PORT: 5672
      AF_RABBITMQ_USER: ${AF_RABBITMQ_USER:-alphafrog}
      AF_RABBITMQ_PASS: ${AF_RABBITMQ_PASS:-Excited1s}
      AF_REDIS_HOST: redis
      AF_REDIS_PORT: 6379
      AF_REDIS_PASSWORD: ${AF_REDIS_PASSWORD:-Excited1s}
      NACOS_ADDRESS: nacos
      # 可选：覆盖 JWT 密钥（默认值在 frontend 的 application.yml 里）
      # AF_JWT_SECRET: ${AF_JWT_SECRET}
      # Memory Optimization (Medium)
      JAVA_TOOL_OPTIONS: "-Xms384m -Xmx512m"
    ports:
      - "8090:8090"
    deploy:
      resources:
        limits:
          memory: 768M
    networks:
      - alphafrog-network

volumes:
  alphafrog_pgdata:
  alphafrog_redisdata:
  alphafrog_rabbitmq:

networks:
  alphafrog-network:
    driver: bridge
