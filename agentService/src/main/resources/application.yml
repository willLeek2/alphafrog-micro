spring:
  application:
    name: agent-service
  datasource:
    url: jdbc:postgresql://${AF_DB_MAIN_HOST:localhost}:${AF_DB_MAIN_PORT:5432}/${AF_DB_MAIN_DATABASE:alphafrog}
    username: ${AF_DB_MAIN_USER:postgres}
    password: ${AF_DB_MAIN_PASSWORD:postgres}
    driver-class-name: org.postgresql.Driver
  data:
    redis:
      host: ${AF_REDIS_HOST:127.0.0.1}
      port: ${AF_REDIS_PORT:6379}
      password: ${AF_REDIS_PASSWORD:}

mybatis:
  mapper-locations: classpath:mapper/*.xml
  configuration:
    map-underscore-to-camel-case: true

dubbo:
  application:
    name: agent-service
  protocol:
    name: tri
    port: 50058
  registry:
    address: nacos://${NACOS_ADDRESS:127.0.0.1}:8848
  consumer:
    check: false

agent:
  run:
    interrupted-ttl-days: ${AF_AGENT_RUN_INTERRUPTED_TTL_DAYS:7}
    checkpoint-version: ${AF_AGENT_RUN_CHECKPOINT_VERSION:v2}
  tool-cache:
    version: ${AF_AGENT_TOOL_CACHE_VERSION:v1}
    search-ttl-seconds: ${AF_AGENT_TOOL_CACHE_SEARCH_TTL_SECONDS:3600}
    info-ttl-seconds: ${AF_AGENT_TOOL_CACHE_INFO_TTL_SECONDS:21600}
    dataset-ttl-seconds: ${AF_AGENT_TOOL_CACHE_DATASET_TTL_SECONDS:604800}
  api:
    max-polling-interval-seconds: ${AF_AGENT_API_MAX_POLLING_INTERVAL_SECONDS:3}
  credit:
    default-tool-cost: ${AF_AGENT_CREDIT_DEFAULT_TOOL_COST:1}
    execute-python-cost: ${AF_AGENT_CREDIT_EXECUTE_PYTHON_COST:5}
  observability:
    debug-file:
      enabled: ${AF_AGENT_OBS_DEBUG_FILE_ENABLED:false}
      path: ${AF_AGENT_OBS_DEBUG_FILE_PATH:/data/logs/agent-observability-debug.log}
    llm-trace:
      enabled: ${AF_AGENT_OBS_LLM_TRACE_ENABLED:false}
      max-calls: ${AF_AGENT_OBS_LLM_TRACE_MAX_CALLS:100}
      max-text-chars: ${AF_AGENT_OBS_LLM_TRACE_MAX_TEXT_CHARS:20000}
    raw-http:
      enabled: ${AF_AGENT_OBS_RAW_HTTP_ENABLED:true}
      capture-body-max-chars: ${AF_AGENT_OBS_RAW_HTTP_MAX_CHARS:100000}
      capture-headers: ${AF_AGENT_OBS_RAW_HTTP_HEADERS:true}
      generate-curl: ${AF_AGENT_OBS_RAW_HTTP_CURL:true}
      capture-endpoints: ${AF_AGENT_OBS_CAPTURE_ENDPOINTS:}
      exclude-endpoints: ${AF_AGENT_OBS_EXCLUDE_ENDPOINTS:}
  artifact:
    retention-days:
      normal: ${AF_AGENT_ARTIFACT_RETENTION_DAYS_NORMAL:7}
      admin: ${AF_AGENT_ARTIFACT_RETENTION_DAYS_ADMIN:30}
    download:
      max-bytes: ${AF_AGENT_ARTIFACT_DOWNLOAD_MAX_BYTES:10485760}
  event:
    payload:
      max-chars: ${AF_AGENT_EVENT_PAYLOAD_MAX_CHARS:10000}
      preview-chars: ${AF_AGENT_EVENT_PAYLOAD_PREVIEW_CHARS:4096}
  llm:
    # 本地 JSON 配置文件（可选，不存在则回退到当前 yml/env 配置）
    config-file: ${AF_AGENT_LLM_CONFIG_FILE:}
    # 本地 JSON 热更新轮询间隔（毫秒）
    config-refresh-interval-ms: ${AF_AGENT_LLM_CONFIG_REFRESH_INTERVAL_MS:10000}
    # 默认模型与端点（用于未指定 model/endpoint 的请求）
    default-endpoint: ${AF_AGENT_DEFAULT_ENDPOINT:openrouter}
    default-model: ${AF_AGENT_DEFAULT_MODEL:openai/gpt-5.2}
    # 允许使用的模型列表（请求不在此列表内将被拒绝）
    # 可通过环境变量 AF_AGENT_MODELS 覆盖，格式: 逗号分隔的模型名
    models: ${AF_AGENT_MODELS:openai/gpt-5.2,openai/gpt-5.1,google/gemini-3-pro-preview,moonshotai/kimi-k2.5,accounts/fireworks/models/kimi-k2p5}
    # 端点名到 base_url 的显式映射
    endpoints:
      openrouter:
        base-url: ${AF_AGENT_ENDPOINT_OPENROUTER:https://openrouter.ai/api/v1}
        api-key: ${AF_AGENT_ENDPOINT_OPENROUTER_API_KEY:}
      openai:
        base-url: ${AF_AGENT_ENDPOINT_OPENAI:https://api.openai.com/v1}
        api-key: ${AF_AGENT_ENDPOINT_OPENAI_API_KEY:}
      fireworks:
        base-url: ${AF_AGENT_ENDPOINT_FIREWORKS:https://api.fireworks.ai/inference/v1}
        api-key: ${AF_AGENT_ENDPOINT_FIREWORKS_API_KEY:}
    openrouter:
      # OpenRouter 推荐的可选请求头
      http-referer: ${AF_OPENROUTER_HTTP_REFERER:}
      title: ${AF_OPENROUTER_TITLE:}
    prompts:
      agent-run-system-prompt: |
        你是专业金融分析代理。请使用可用工具获取市场数据并准确回答用户问题。
        重要约束：
        1. 你通常并不知道数据库中的精确 ts_code（例如 000300.SH），必须先调用 searchStock/searchFund/searchIndex 检索后再调用按代码查询的工具；从搜索结果 data.items 中选取最符合用户意图的项（比对 name 与用户目标），不要默认取第一条。
        2. 禁止猜测代码，禁止使用不存在的工具名。
        3. 当市场数据工具返回 dataset_id 后，必须调用 executePython 对数据进行计算与分析。
        4. Python 环境预装 numpy、pandas、matplotlib、scipy，优先使用这些库完成数据处理与计算。
        5. 所有工具输出均为 JSON：{"ok":boolean,"tool":"...","data":{...},"error":{...}|null}。读取字段必须从 data 中取值，禁止按自然语言文本解析。
      todo-planner-system-prompt-template: >
        你是任务规划器。请将用户目标拆解为 Todo List，只输出 JSON。
        格式：{"analysis":"...","items":[{"id":"todo_1","sequence":1,"type":"TOOL_CALL","toolName":"searchIndex","params":{"keyword":"沪深300"},"reasoning":"...","executionMode":"AUTO"}]}。
        约束：步骤数 <= {{maxTodos}}，仅允许工具 {{toolWhitelist}}；type 仅 TOOL_CALL/SUB_AGENT/THOUGHT；executionMode 仅 AUTO/FORCE_SIMPLE/FORCE_SUB_AGENT。
      workflow-final-system-prompt: |
        你是金融分析助手，请基于 Todo 执行结果给出最终结论。
        结论应直接回答用户目标，并包含关键数据与口径说明。
      workflow-todo-recovery-system-prompt: |
        某 Todo 工具调用失败，请根据错误信息与已成功完成的 Todo 上下文，修正参数后重试。
        只输出 JSON，格式为 {"params":{...}} 表示用新参数重试，或 {"abandon":true,"reason":"..."} 表示放弃。
        参数引用格式：使用 ${todo_id.output} 或 ${todo_id.output.data.items.0.ts_code} 引用已完成 Todo 的输出；或直接从上下文中提取具体值（如 ts_code: "000300.SH"）。
      semantic-judge-system-prompt-template: |
        你是金融分析任务中的语义校验器。必须只输出 JSON：{"pass":true|false,"category":"OK|NUMERIC_ANOMALY|TIME_RANGE_MISMATCH|DOMAIN_INVARIANT_VIOLATION|INSUFFICIENT_EVIDENCE","severity":"LOW|MEDIUM|HIGH","reason_cn":"...","fix_hint":"..."}。
        若证据不足请返回 pass=false 且 category=INSUFFICIENT_EVIDENCE，并在 fix_hint 说明缺失信息。
      parallel-planner-system-prompt-template: >
        你是并行任务规划器。只输出 JSON。必须输出格式：{"strategy":"parallel","tasks":[...],"finalHint":"..."}。
        任务字段：id,type( tool | sub_agent ),tool,args,dependsOn,goal,maxSteps,description。
        请优先拆分为可并行任务，但不要牺牲正确性。约束：任务数 <= {{maxTasks}}，sub_agent 步数 <= {{maxSubSteps}}，
        并行任务数 <= {{maxParallelTasks}}，sub_agent 任务数 <= {{maxSubAgents}}。仅允许工具：{{toolWhitelist}}。
        可并行任务应设置为空依赖；有依赖任务用 dependsOn。
        任务间引用协议必须统一为 ${task_id.output} 或 ${task_id.output.path.to.field}。
        禁止使用 {{...}}、{...}、task.output 这类非标准写法；禁止在 args 里输出无法解析的占位符。
        search 类工具输出字段示例：${task_search.output.data.items.0.ts_code}；日线工具 dataset_id 字段示例：${task_daily.output.data.dataset_id}。引用 search 类任务 items 时，必须根据用户目标选取 name 最匹配的项，不可默认使用 items.0。
      parallel-patch-planner-system-prompt-template: >
        你是运行中 DAG 的局部重规划器。只输出 JSON，格式严格为 {"reason":"...","replace_task_ids":["..."],"tasks":[...]}。
        tasks 的字段与主计划一致：id,type( tool | sub_agent ),tool,args,dependsOn,goal,maxSteps,description。
        约束：1) 仅修复 unresolved 子图及其下游；2) 不重建已成功节点；3) 依赖必须闭合且可执行；4) 不输出 markdown。
        任务间引用协议必须统一为 ${task_id.output} 或 ${task_id.output.path.to.field}。
        禁止使用 {{...}}、{...}、task.output 这类非标准写法；禁止在 args 里输出无法解析的占位符。
      parallel-final-system-prompt: |
        你是金融分析助手，请基于任务结果给出最终结论。
        要求结论可直接回答用户目标，优先保留关键数值、口径与结论，不要只复述过程。
      sub-agent-planner-system-prompt-template: >
        你是一个子任务代理。必须先输出线性计划 JSON，不超过 {{maxSteps}} 步。仅能使用下列工具名称：{{tools}}。
        严禁把 sub_agent、workflow、tool、agent 作为步骤工具名。工具参数必须严格匹配真实签名：
        searchIndex/searchStock/searchFund 使用 keyword；
        getIndexDaily/getStockDaily 使用 tsCode,startDateStr,endDateStr（日期格式必须为YYYYMMDD）；
        executePython 使用 code,dataset_id；可选传 coding_context（仅保留与编码最相关上下文）。
        从 search 类工具返回的 items 中选取最符合用户意图的项，不要默认取第一条。
        输出格式：{"steps":[{"tool":"name","args":{...},"note":"why"}],"expected":"..."}。
      sub-agent-summary-system-prompt: |
        请基于以下工具执行结果，输出简洁结论用于主流程合并。
        结论需优先包含关键数值、时间范围与约束条件，避免冗长叙述。
      python-refine-system-prompt: >
        你是代码执行代理。请基于目标、相关上下文和执行反馈，输出可直接运行的 Python 代码和运行参数。
        必须只输出 JSON，格式为 {"code":"...","run_args":{"dataset_id":"...","dataset_ids":"...","libraries":"...","timeout_seconds":30},"reason":"..."}。
        run_args 中最关键是 dataset_id，必须指向真实可访问的数据目录。
      python-refine-requirements:
        - 你可以在本轮修正 run_args，尤其是 dataset_id/dataset_ids。
        - 代码中不要假设未定义变量，直接按可访问文件路径读取数据。
        - 数据文件路径固定为 /sandbox/input/<dataset_id>/<dataset_id>.csv。
        - 读取数据时必须使用 pd.read_csv(f"/sandbox/input/{dataset_id}/{dataset_id}.csv")，禁止使用未定义的函数如 load_dataset() 或 get_dataset()。
        - 日期字段请先排序后再取首尾行，不要硬编码某个交易日一定存在。
        - trade_date 常见为 YYYYMMDD 数字串；优先使用 astype(str) 后提取 8 位数字并按字符串排序。
        - 非必要不要使用 pd.to_datetime；若上轮出现 to_datetime/Overflow/unconverted 错误，本轮必须改为字符串排序方案。
        - 价格字段请优先使用 close/open 等数值列，避免把 ts_code 当作价格。
        - ts_code 是数据库内区分不同资产的标识字段，不可用于涨跌幅数值计算。
        - 优先输出 JSON 结果，便于后续流程消费。
        - 若上轮报 dataset_id 相关错误，必须优先修正 run_args 再生成代码。
      python-refine-output-instruction: 请只返回 JSON，不要返回 markdown。
      dataset-field-specs:
        - name: ts_code
          meaning: 资产代码（股票/指数唯一标识）
          data-type: string
          data-format: 交易所后缀代码，如 000300.SH
        - name: trade_date
          meaning: 交易日期
          data-type: string
          data-format: YYYYMMDD（8位日期字符串）
        - name: open
          meaning: 当日开盘价
          data-type: float
          data-format: 十进制数值
        - name: high
          meaning: 当日最高价
          data-type: float
          data-format: 十进制数值
        - name: low
          meaning: 当日最低价
          data-type: float
          data-format: 十进制数值
        - name: close
          meaning: 当日收盘价
          data-type: float
          data-format: 十进制数值
        - name: pre_close
          meaning: 前一交易日收盘价
          data-type: float
          data-format: 十进制数值
        - name: change
          meaning: 绝对涨跌额
          data-type: float
          data-format: 当日收盘价-前收盘价
        - name: pct_chg
          meaning: 涨跌幅百分比
          data-type: float
          data-format: 百分比数值（如 1.23 表示 1.23%）
        - name: vol
          meaning: 成交量
          data-type: float
          data-format: 原始成交量数值（单位依数据源定义）
        - name: amount
          meaning: 成交额
          data-type: float
          data-format: 原始成交额数值（单位依数据源定义）
      orchestrator-planning-system-prompt: |
        你是专业金融规划助手。请把用户高层目标拆解为可执行步骤，并输出严格 JSON。
        输出步骤需明确目标、所需工具与参数约束，不要输出 markdown 包裹。
      orchestrator-summary-system-prompt: |
        你是专业金融分析助手。请基于执行日志输出简洁、清晰、可直接给用户的总结结论。
        优先突出结果与关键数据点，不要仅复述过程。
    runtime:
      execution:
        static-precheck-enabled: ${AF_AGENT_RUNTIME_EXECUTION_STATIC_PRECHECK_ENABLED:true}
        max-static-recovery-retries: ${AF_AGENT_RUNTIME_EXECUTION_MAX_STATIC_RECOVERY_RETRIES:2}
        max-runtime-recovery-retries: ${AF_AGENT_RUNTIME_EXECUTION_MAX_RUNTIME_RECOVERY_RETRIES:2}
        max-semantic-recovery-retries: ${AF_AGENT_RUNTIME_EXECUTION_MAX_SEMANTIC_RECOVERY_RETRIES:1}
        max-total-recovery-retries: ${AF_AGENT_RUNTIME_EXECUTION_MAX_TOTAL_RECOVERY_RETRIES:2}
        static-fix-endpoint: ${AF_AGENT_RUNTIME_EXECUTION_STATIC_FIX_ENDPOINT:}
        static-fix-model: ${AF_AGENT_RUNTIME_EXECUTION_STATIC_FIX_MODEL:}
        static-fix-temperature: ${AF_AGENT_RUNTIME_EXECUTION_STATIC_FIX_TEMPERATURE:0.0}
      judge:
        semantic-enabled: ${AF_AGENT_RUNTIME_JUDGE_SEMANTIC_ENABLED:false}
        max-attempts: ${AF_AGENT_RUNTIME_JUDGE_MAX_ATTEMPTS:2}
        fail-open: ${AF_AGENT_RUNTIME_JUDGE_FAIL_OPEN:true}
        block-on-insufficient-evidence: ${AF_AGENT_RUNTIME_JUDGE_BLOCK_ON_INSUFFICIENT_EVIDENCE:false}
  search-llm:
    # 本地 JSON 配置文件（可选，不存在则回退到当前 yml/env 配置）
    config-file: ${AF_AGENT_SEARCH_LLM_CONFIG_FILE:}
    # 本地 JSON 热更新轮询间隔（毫秒）
    config-refresh-interval-ms: ${AF_AGENT_SEARCH_LLM_CONFIG_REFRESH_INTERVAL_MS:10000}
    default-provider: ${AF_AGENT_SEARCH_LLM_DEFAULT_PROVIDER:exa}
    providers:
      perplexity:
        base-url: ${AF_AGENT_SEARCH_PPLX_BASE_URL:https://api.perplexity.ai}
        api-key: ${AF_AGENT_SEARCH_PPLX_API_KEY:}
        search-path: ${AF_AGENT_SEARCH_PPLX_SEARCH_PATH:/search}
        auth-header: ${AF_AGENT_SEARCH_PPLX_AUTH_HEADER:Authorization}
        auth-prefix: ${AF_AGENT_SEARCH_PPLX_AUTH_PREFIX:Bearer }
        connect-timeout-seconds: ${AF_AGENT_SEARCH_PPLX_CONNECT_TIMEOUT_SECONDS:20}
        request-timeout-seconds: ${AF_AGENT_SEARCH_PPLX_REQUEST_TIMEOUT_SECONDS:45}
      exa:
        base-url: ${AF_AGENT_SEARCH_EXA_BASE_URL:https://api.exa.ai}
        api-key: ${AF_AGENT_SEARCH_EXA_API_KEY:}
        search-path: ${AF_AGENT_SEARCH_EXA_SEARCH_PATH:/search}
        auth-header: ${AF_AGENT_SEARCH_EXA_AUTH_HEADER:x-api-key}
        auth-prefix: ${AF_AGENT_SEARCH_EXA_AUTH_PREFIX:}
        connect-timeout-seconds: ${AF_AGENT_SEARCH_EXA_CONNECT_TIMEOUT_SECONDS:20}
        request-timeout-seconds: ${AF_AGENT_SEARCH_EXA_REQUEST_TIMEOUT_SECONDS:45}
    market-news:
      default-limit: ${AF_AGENT_SEARCH_MARKET_NEWS_DEFAULT_LIMIT:8}
      max-results: ${AF_AGENT_SEARCH_MARKET_NEWS_MAX_RESULTS:20}
      max-tokens-per-page: ${AF_AGENT_SEARCH_MARKET_NEWS_MAX_TOKENS_PER_PAGE:1024}
      country: ${AF_AGENT_SEARCH_MARKET_NEWS_COUNTRY:CN}
      user-location: ${AF_AGENT_SEARCH_MARKET_NEWS_USER_LOCATION:CN}
      exa-search-type: ${AF_AGENT_SEARCH_MARKET_NEWS_EXA_TYPE:auto}
      exa-category: ${AF_AGENT_SEARCH_MARKET_NEWS_EXA_CATEGORY:news}
      include-domains:
        - sina.com.cn
        - eastmoney.com
        - cls.cn
        - yicai.com
        - wallstreetcn.com
      languages:
        - zh
        - en
      queries:
        - 今日A股市场行情
        - 央行政策公告
        - 美股市场要闻
        - 全球市场动态
        - 行业板块热点
      category-keywords:
        policy: ${AF_AGENT_SEARCH_MARKET_NEWS_KEYWORDS_POLICY:央行,政策,逆回购}
        global: ${AF_AGENT_SEARCH_MARKET_NEWS_KEYWORDS_GLOBAL:美股,美联储,纳指,道指}
        sector: ${AF_AGENT_SEARCH_MARKET_NEWS_KEYWORDS_SECTOR:行业,板块,龙头}
        market: ${AF_AGENT_SEARCH_MARKET_NEWS_KEYWORDS_MARKET:A股,沪深,指数,开盘}
    prompts:
      market-news-query-template: ${AF_AGENT_SEARCH_PROMPTS_MARKET_NEWS_QUERY_TEMPLATE:}
  tools:
    market-data:
      dataset:
        enabled: ${AF_AGENT_MARKET_DATA_DATASET_ENABLED:true}
        path: ${AF_AGENT_MARKET_DATA_DATASET_PATH:/data/agent_datasets}
        cache-ttl-seconds: ${AF_AGENT_MARKET_DATA_DATASET_TTL_SECONDS:604800}
        allow-range-reuse: ${AF_AGENT_MARKET_DATA_DATASET_ALLOW_RANGE_REUSE:true}
        cleanup-interval-ms: ${AF_AGENT_MARKET_DATA_DATASET_CLEANUP_INTERVAL_MS:600000}
        cleanup-scan-count: ${AF_AGENT_MARKET_DATA_DATASET_CLEANUP_SCAN_COUNT:500}
  flow:
    parallel:
      enabled: ${AF_AGENT_FLOW_PARALLEL_ENABLED:false}
    workflow:
      max-todos: ${AF_AGENT_FLOW_WORKFLOW_MAX_TODOS:10}
      max-tool-calls: ${AF_AGENT_FLOW_WORKFLOW_MAX_TOOL_CALLS:20}
      max-tool-calls-per-sub-agent: ${AF_AGENT_FLOW_WORKFLOW_MAX_TOOL_CALLS_PER_SUB_AGENT:10}
      fail-fast: ${AF_AGENT_FLOW_WORKFLOW_FAIL_FAST:false}
      default-execution-mode: ${AF_AGENT_FLOW_WORKFLOW_DEFAULT_EXECUTION_MODE:AUTO}
      sub-agent-enabled: ${AF_AGENT_FLOW_WORKFLOW_SUB_AGENT_ENABLED:true}
      sub-agent-max-steps: ${AF_AGENT_FLOW_WORKFLOW_SUB_AGENT_MAX_STEPS:6}
    code-refine:
      config-file: ${AF_AGENT_FLOW_CODE_REFINE_CONFIG_FILE:}
      max-attempts: ${AF_AGENT_FLOW_CODE_REFINE_MAX_ATTEMPTS:3}
    hitl:
      state-ttl-seconds: ${AF_AGENT_FLOW_HITL_STATE_TTL_SECONDS:3600}

langchain4j:
  open-ai:
    api-key: ${AF_AGENT_API_KEY:demo}
    base-url: ${AF_AGENT_BASE_URL:https://openrouter.ai/api/v1}
    model-name: ${AF_AGENT_MODEL_NAME:openai/gpt-4o}
    max-tokens: ${AF_AGENT_MAX_TOKENS:4096}
    temperature: ${AF_AGENT_TEMPERATURE:0.7}
    # Reasoning 配置 (OpenRouter 兼容)
    # 参考: https://openrouter.ai/docs/guides/best-practices/reasoning-tokens
    reasoning:
      # effort: xhigh, high, medium, low, minimal, none (用于 OpenAI o系列, Grok)
      effort: ${AF_AGENT_REASONING_EFFORT:#{null}}
      # max-tokens: 直接指定 reasoning token 数 (用于 Anthropic Claude, Gemini)
      max-tokens: ${AF_AGENT_REASONING_MAX_TOKENS:#{null}}
      # exclude: 是否在响应中排除 reasoning 内容
      exclude: ${AF_AGENT_REASONING_EXCLUDE:false}
      # enabled: 显式启用 reasoning (用于 DeepSeek)
      enabled: ${AF_AGENT_REASONING_ENABLED:#{null}}

logging:
  level:
    world.willfrog.agent: ${LOGGING_LEVEL_AGENT:INFO}
    dev.langchain4j: ${LOGGING_LEVEL_LANGCHAIN4J:DEBUG}
    dev.ai4j.openai4j: ${LOGGING_LEVEL_OPENAI4J:${LOGGING_LEVEL_AGENT:INFO}}
